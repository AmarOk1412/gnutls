\begin {verbatim}

/* This file is actually an example of using the OpenCDK library
 * to retrieve an OpenPGP key from a key server.
 */

#include <stdlib.h>
#include <gnutls/gnutls.h>
#include <gnutls/extra.h>
#include <opencdk.h>

/* A callback function that tries to connect
 * to a public keyserver to get the specified key.
 * The callback should be set as:
 *
 * gnutls_openpgp_set_recv_key_function( session, recv_openpgp_key);
 *
 * in the initialization of a gnutls session.
 */

static const char *hostname = "keyserver.somewhere.com";
static const short port = 11371;

int
recv_openpgp_key(const unsigned char *keyfpr, unsigned int
                 keyfpr_length, gnutls_datum * key)
{
   const unsigned char *keyid;
   int rc;
   CDK_KBNODE knode = NULL;

   /* The key fingerprint should be 20 bytes
    */
   if (keyfpr_length != 20)
      return -1;

   /* The key id is the last 4 bytes of the key fingerprint
    */
   keyid = &keyfpr[16];

   if (key == NULL) {
      return -1;
   }

   rc = cdk_keyserver_recv_key( hostname, port, keyid, &knode );
   if( !rc ) {
       unsigned char *buf = cdk_calloc( 1, 20001 );
       size_t len = 20000;
       cdk_kbnode_write_to_mem( knode, buf, &len);

       key->data = malloc( len);
       if (key->data==NULL) return -1;
       memcpy( key->data, buf, len);

       cdk_free( buf );
   }
   cdk_kbnode_release( knode );
   return map_cdk_rc( rc );

}


\end{verbatim}
